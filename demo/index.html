<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Galaxy Model Demo</title>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://unpkg.com/three/build/three.min.js"></script>
  <script src="https://unpkg.com/react-force-graph-3d"></script>
  <style>
    body { font-family: sans-serif; margin:0; }
    #root { height: 80vh; }
    #controls { padding: 10px; }
    #inspector { padding: 10px; border-top: 1px solid #ccc; height: 20vh; overflow:auto; }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="inspector"></div>

  <script type="text/babel">
    const { useState, useMemo, useRef } = React;

    function App() {
      const [data, setData] = useState({nodes: [], links: []});
      const [eta, setEta] = useState(100);
      const fgRef = useRef();

      const threshold = useMemo(() => {
        if (!data.nodes.length) return 0;
        const confidences = data.nodes.map(n => n.confidence).sort((a,b) => a-b);
        const idx = Math.floor((100 - eta) / 100 * (confidences.length - 1));
        return confidences[idx];
      }, [eta, data]);

      const runAnalysis = () => {
        fetch('http://localhost:8000/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({prompt: 'demo prompt'})
        })
        .then(res => res.json())
        .then(json => setData(json.graph_data));
      };

      const nodes = data.nodes.map(n => ({...n, opacity: n.confidence >= threshold ? 1 : 0.1}));

      return (
        <div>
          <div id="controls">
            <button onClick={runAnalysis}>Run Analysis</button>
            <label style={{marginLeft: '10px'}}>Cognitive Strategy (Î·)
              <input type="range" min="1" max="100" value={eta} onChange={e => setEta(+e.target.value)} />
            </label>
          </div>
          <ForceGraph3D
            ref={fgRef}
            graphData={{nodes, links: data.links}}
            nodeThreeObject={node => {
              const size = 0.5 + node.confidence * 2;
              const geometry = new THREE.SphereGeometry(size, 16, 16);
              const material = new THREE.MeshBasicMaterial({
                color: colorForAnswer(node.answer),
                transparent: true,
                opacity: node.opacity
              });
              return new THREE.Mesh(geometry, material);
            }}
            onNodeClick={node => {
              document.getElementById('inspector').textContent = node.full_text;
            }}
          />
        </div>
      );
    }

    function colorForAnswer(ans) {
      const palette = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];
      let hash = 0;
      for (let i = 0; i < ans.length; i++) {
        hash = (hash + ans.charCodeAt(i)) % palette.length;
      }
      return palette[hash];
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
