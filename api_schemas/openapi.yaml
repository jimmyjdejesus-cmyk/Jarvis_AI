# AdaptiveMind Framework
# Copyright (c) 2025 Jimmy De Jesus
# Licensed under CC-BY 4.0
#
# AdaptiveMind - Intelligent AI Routing & Context Engine
# More info: https://github.com/[username]/adaptivemind
# License: https://creativecommons.org/licenses/by/4.0/



openapi: 3.0.3
info:
  title: Jarvis AI API v1
  description: |
    Local-first AI orchestration platform providing chat, persona management, monitoring, and system configuration capabilities.
    
    ## Authentication
    All endpoints require authentication via the `X-API-Key` header. Set `JARVIS_DISABLE_AUTH=true` to bypass authentication locally.
    
    ## Endpoint Categories
    - **Core API** (`/api/v1/*`): Main Jarvis functionality
    - **Management API** (`/api/v1/management/*`): System configuration and persona management
    - **OpenAI-Compatible** (`/v1/*`): Drop-in replacement for OpenAI API clients
  version: "1.0.0"
  contact:
    name: Jarvis AI Support
    email: support@jarvis.ai
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://127.0.0.1:8000
    description: Local development server
  - url: https://api.jarvis.ai
    description: Production server

security:
  - ApiKeyAuth: []

paths:
  # ============================================================
  # Health & Status
  # ============================================================
  /health:
    get:
      summary: Health check
      description: Check the health status of the API and available models
      tags: [Health]
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok
                available_models:
                  - "ollama"
                  - "openrouter"

  # ============================================================
  # Core API - Models
  # ============================================================
  /api/v1/models:
    get:
      summary: List available models
      description: Get a list of all available AI model backends
      tags: [Models]
      responses:
        '200':
          description: List of available model backend names
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
              example:
                - "ollama"
                - "openrouter"
                - "windowsml"
                - "contextual-fallback"

  # ============================================================
  # Core API - Personas
  # ============================================================
  /api/v1/personas:
    get:
      summary: List personas
      description: Get a list of all configured personas with their descriptions
      tags: [Personas]
      responses:
        '200':
          description: List of personas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PersonaSummary'
              example:
                - name: "generalist"
                  description: "General purpose assistant"
                  max_context_window: 4096
                  routing_hint: "general"

  # ============================================================
  # Core API - Chat
  # ============================================================
  /api/v1/chat:
    post:
      summary: Chat completion
      description: Generate a chat response using the specified persona and AI models
      tags: [Chat]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            example:
              messages:
                - role: user
                  content: "Hello, how are you?"
              persona: "generalist"
              temperature: 0.7
              max_tokens: 512
      responses:
        '200':
          description: Chat response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              example:
                content: "I'm doing well, thank you for asking! How can I help you today?"
                model: "ollama"
                tokens: 25
                diagnostics: {}
        '400':
          description: Bad request (e.g., persona not found)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================
  # Core API - Monitoring
  # ============================================================
  /api/v1/monitoring/metrics:
    get:
      summary: Get metrics history
      description: Get historical performance metrics snapshots
      tags: [Monitoring]
      responses:
        '200':
          description: Metrics history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
              example:
                history:
                  - request_count: 150
                    average_latency_ms: 245.6
                    max_latency_ms: 890.2
                    tokens_generated: 5000
                    context_tokens: 12000
                    personas_used: ["generalist", "researcher"]

  /api/v1/monitoring/traces:
    get:
      summary: Get request traces
      description: Get recent request traces for debugging and diagnostics
      tags: [Monitoring]
      responses:
        '200':
          description: Request traces
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TracesResponse'
              example:
                traces:
                  - persona: "generalist"
                    backend: "ollama"
                    latency_ms: 234.5
                    tokens: 50
                    timestamp: "2025-12-15T12:34:35Z"

  # ============================================================
  # Management API - System
  # ============================================================
  /api/v1/management/system/status:
    get:
      summary: Get system status
      description: Get comprehensive system status including uptime, active backends, and configuration hash
      tags: [Management]
      responses:
        '200':
          description: System status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatusResponse'
              example:
                status: "healthy"
                uptime_seconds: 3600.5
                version: "1.0.0"
                active_backends: ["ollama", "openrouter"]
                active_personas: ["generalist", "researcher"]
                config_hash: "a1b2c3d4e5f6g7h8"

  # ============================================================
  # Management API - Routing
  # ============================================================
  /api/v1/management/routing/config:
    get:
      summary: Get routing configuration
      description: Get current routing and persona configuration
      tags: [Management]
      responses:
        '200':
          description: Routing configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoutingConfigResponse'
              example:
                allowed_personas: ["generalist", "researcher", "coder"]
                enable_adaptive_routing: true

  /api/v1/management/config/routing:
    put:
      summary: Update routing configuration
      description: Update routing configuration including allowed personas
      tags: [Management]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoutingConfigUpdateRequest'
      responses:
        '200':
          description: Updated routing configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoutingConfigResponse'
        '400':
          description: Bad request (e.g., persona doesn't exist)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================
  # Management API - Backends
  # ============================================================
  /api/v1/management/backends:
    get:
      summary: List backends
      description: Get status information for all configured LLM backends
      tags: [Management]
      responses:
        '200':
          description: Backend list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackendListResponse'
              example:
                backends:
                  - name: "ollama"
                    type: "ollama"
                    is_available: true
                    last_checked: 1702648475.123
                    config: {}

  /api/v1/management/backends/{name}/test:
    post:
      summary: Test backend
      description: Test connectivity and availability of a specific backend
      tags: [Management]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Backend name to test
      responses:
        '200':
          description: Test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackendTestResponse'
              example:
                success: true
                latency_ms: 45.2
                error: null
        '404':
          description: Backend not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================
  # Management API - Context
  # ============================================================
  /api/v1/management/context/config:
    get:
      summary: Get context configuration
      description: Get current context pipeline configuration
      tags: [Management]
      responses:
        '200':
          description: Context configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContextConfigResponse'
              example:
                extra_documents_dir: null
                enable_semantic_chunking: true
                max_combined_context_tokens: 8192

  /api/v1/management/config/context:
    put:
      summary: Update context configuration
      description: Update context pipeline configuration
      tags: [Management]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContextConfigUpdateRequest'
      responses:
        '200':
          description: Updated context configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContextConfigResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================
  # Management API - Security
  # ============================================================
  /api/v1/management/security/status:
    get:
      summary: Get security status
      description: Get security configuration and status information
      tags: [Management]
      responses:
        '200':
          description: Security status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityStatusResponse'
              example:
                api_keys_count: 2
                audit_log_enabled: true

  # ============================================================
  # Management API - Personas CRUD
  # ============================================================
  /api/v1/management/personas:
    post:
      summary: Create persona
      description: Create a new persona configuration
      tags: [Management]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PersonaCreateRequest'
      responses:
        '200':
          description: Created persona
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonaResponse'
        '400':
          description: Bad request (e.g., persona already exists)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/management/personas/{name}:
    put:
      summary: Update persona
      description: Update an existing persona configuration
      tags: [Management]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Persona name to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PersonaUpdateRequest'
      responses:
        '200':
          description: Updated persona
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonaResponse'
        '404':
          description: Persona not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete persona
      description: Delete a persona configuration
      tags: [Management]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Persona name to delete
      responses:
        '200':
          description: Deletion confirmation
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Persona 'custom-persona' deleted successfully"
        '404':
          description: Persona not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================
  # Management API - Config Save
  # ============================================================
  /api/v1/management/config/save:
    post:
      summary: Save configuration
      description: Save current configuration to persistent storage
      tags: [Management]
      responses:
        '200':
          description: Save result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigSaveResponse'
              example:
                success: true
                config_hash: "a1b2c3d4e5f6g7h8"
                message: "Configuration saved successfully (in-memory only for now)"

  # ============================================================
  # OpenAI-Compatible Endpoints
  # ============================================================
  /v1/chat/completions:
    post:
      summary: OpenAI-compatible chat completions
      description: |
        Drop-in replacement for OpenAI's chat completions API.
        The `model` parameter is mapped to a Jarvis persona if it exists, otherwise defaults to "generalist".
      tags: [OpenAI Compatible]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OpenAIChatRequest'
            example:
              model: "jarvis-default"
              messages:
                - role: user
                  content: "Hello!"
              temperature: 0.7
              max_tokens: 512
              stream: false
      responses:
        '200':
          description: Chat completion response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenAIChatResponse'
              example:
                id: "chatcmpl-1702648475"
                object: "chat.completion"
                created: 1702648475
                model: "ollama"
                choices:
                  - index: 0
                    message:
                      role: "assistant"
                      content: "Hello! How can I help you today?"
                    finish_reason: "stop"
                usage:
                  prompt_tokens: 10
                  completion_tokens: 15
                  total_tokens: 25

  /v1/models:
    get:
      summary: OpenAI-compatible models list
      description: List available models in OpenAI-compatible format
      tags: [OpenAI Compatible]
      responses:
        '200':
          description: Models list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenAIModelsResponse'
              example:
                object: "list"
                data:
                  - id: "llama3.2:latest"
                    object: "model"
                    created: 1702648475
                    owned_by: "jarvis"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

  schemas:
    # ============================================================
    # Error Response
    # ============================================================
    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
          description: Error message
      required:
        - detail

    # ============================================================
    # Health
    # ============================================================
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded]
          description: Overall health status
        available_models:
          type: array
          items:
            type: string
          description: List of available model backends
      required:
        - status
        - available_models

    # ============================================================
    # Chat Models
    # ============================================================
    Message:
      type: object
      properties:
        role:
          type: string
          description: Role of the speaker (user, assistant, system)
        content:
          type: string
          description: Message content
      required:
        - role
        - content

    ChatRequest:
      type: object
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
          description: Conversation messages
        persona:
          type: string
          default: "generalist"
          description: Persona to route the request
        temperature:
          type: number
          format: float
          default: 0.7
          minimum: 0.0
          maximum: 2.0
          description: Controls randomness in generation
        max_tokens:
          type: integer
          default: 512
          minimum: 32
          maximum: 4096
          description: Maximum tokens to generate
        metadata:
          type: object
          description: Optional metadata for the request
        external_context:
          type: array
          items:
            type: string
          description: Optional external context strings
      required:
        - messages

    ChatResponse:
      type: object
      properties:
        content:
          type: string
          description: Generated response text
        model:
          type: string
          description: Backend model used for generation
        tokens:
          type: integer
          description: Number of tokens generated
        diagnostics:
          type: object
          description: Backend-specific diagnostic information
      required:
        - content
        - model
        - tokens
        - diagnostics

    # ============================================================
    # Persona Models
    # ============================================================
    PersonaSummary:
      type: object
      properties:
        name:
          type: string
          description: Persona name
        description:
          type: string
          description: Persona description
        max_context_window:
          type: integer
          description: Maximum context window size
        routing_hint:
          type: string
          description: Routing hint for backend selection
      required:
        - name
        - description
        - max_context_window
        - routing_hint

    PersonaCreateRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[a-zA-Z0-9_-]+$'
          description: Unique persona name
        description:
          type: string
          minLength: 1
          maxLength: 200
          description: Persona description
        system_prompt:
          type: string
          minLength: 1
          description: System prompt for the persona
        max_context_window:
          type: integer
          default: 4096
          minimum: 512
          maximum: 32768
          description: Maximum context window size
        routing_hint:
          type: string
          default: "general"
          minLength: 1
          maxLength: 50
          description: Routing hint for backend selection
      required:
        - name
        - description
        - system_prompt

    PersonaUpdateRequest:
      type: object
      properties:
        description:
          type: string
          minLength: 1
          maxLength: 200
          description: Updated description
        system_prompt:
          type: string
          minLength: 1
          description: Updated system prompt
        max_context_window:
          type: integer
          minimum: 512
          maximum: 32768
          description: Updated max context window
        routing_hint:
          type: string
          minLength: 1
          maxLength: 50
          description: Updated routing hint

    PersonaResponse:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        system_prompt:
          type: string
        max_context_window:
          type: integer
        routing_hint:
          type: string
        is_active:
          type: boolean
          description: Whether persona is in allowed_personas list
      required:
        - name
        - description
        - system_prompt
        - max_context_window
        - routing_hint
        - is_active

    # ============================================================
    # Monitoring Models
    # ============================================================
    MetricsResponse:
      type: object
      properties:
        history:
          type: array
          items:
            type: object
          description: Historical metrics snapshots
      required:
        - history

    TracesResponse:
      type: object
      properties:
        traces:
          type: array
          items:
            type: object
          description: Recent request traces
      required:
        - traces

    # ============================================================
    # Management Models
    # ============================================================
    SystemStatusResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Overall system health
        uptime_seconds:
          type: number
          format: float
          description: Time since application startup
        version:
          type: string
          description: Application version
        active_backends:
          type: array
          items:
            type: string
          description: List of available backend names
        active_personas:
          type: array
          items:
            type: string
          description: List of allowed personas
        config_hash:
          type: string
          description: Hash of current configuration for change detection
      required:
        - status
        - uptime_seconds
        - version
        - active_backends
        - active_personas
        - config_hash

    RoutingConfigResponse:
      type: object
      properties:
        allowed_personas:
          type: array
          items:
            type: string
          description: List of personas allowed for routing
        enable_adaptive_routing:
          type: boolean
          default: true
          description: Whether adaptive routing is enabled
      required:
        - allowed_personas
        - enable_adaptive_routing

    RoutingConfigUpdateRequest:
      type: object
      properties:
        allowed_personas:
          type: array
          items:
            type: string
          description: Updated list of allowed personas
        enable_adaptive_routing:
          type: boolean
          description: Enable/disable adaptive routing

    BackendStatus:
      type: object
      properties:
        name:
          type: string
          description: Backend name
        type:
          type: string
          description: Backend type (ollama, openrouter, windowsml, fallback)
        is_available:
          type: boolean
          description: Whether backend is currently operational
        last_checked:
          type: number
          format: float
          description: Timestamp of last availability check
        config:
          type: object
          description: Backend configuration (secrets excluded)
      required:
        - name
        - type
        - is_available

    BackendListResponse:
      type: object
      properties:
        backends:
          type: array
          items:
            $ref: '#/components/schemas/BackendStatus'
      required:
        - backends

    BackendTestResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether backend is available
        latency_ms:
          type: number
          format: float
          description: Response time in milliseconds
        error:
          type: string
          nullable: true
          description: Error message if test failed
      required:
        - success

    ContextConfigResponse:
      type: object
      properties:
        extra_documents_dir:
          type: string
          nullable: true
          description: Directory for additional documents
        enable_semantic_chunking:
          type: boolean
          description: Whether semantic chunking is enabled
        max_combined_context_tokens:
          type: integer
          description: Maximum tokens for combined context
      required:
        - enable_semantic_chunking
        - max_combined_context_tokens

    ContextConfigUpdateRequest:
      type: object
      properties:
        extra_documents_dir:
          type: string
          description: Path to additional documents directory
        enable_semantic_chunking:
          type: boolean
          description: Enable/disable semantic chunking
        max_combined_context_tokens:
          type: integer
          minimum: 1024
          maximum: 65536
          description: Maximum tokens for context

    SecurityStatusResponse:
      type: object
      properties:
        api_keys_count:
          type: integer
          description: Number of configured API keys
        audit_log_enabled:
          type: boolean
          description: Whether audit logging is enabled
      required:
        - api_keys_count
        - audit_log_enabled

    ConfigSaveResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether save operation succeeded
        config_hash:
          type: string
          description: Hash of saved configuration
        message:
          type: string
          description: Status message
      required:
        - success
        - config_hash
        - message

    # ============================================================
    # OpenAI-Compatible Models
    # ============================================================
    OpenAIChatRequest:
      type: object
      properties:
        model:
          type: string
          default: "jarvis-default"
          description: Model name (mapped to persona if exists)
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
          description: Conversation messages
        temperature:
          type: number
          format: float
          default: 0.7
          description: Controls randomness
        max_tokens:
          type: integer
          default: 512
          minimum: 32
          maximum: 4096
          description: Maximum tokens to generate
        stream:
          type: boolean
          default: false
          description: Whether to stream response (not yet implemented)
      required:
        - messages

    OpenAIChatResponse:
      type: object
      properties:
        id:
          type: string
          description: Unique completion ID
        object:
          type: string
          default: "chat.completion"
        created:
          type: integer
          description: Unix timestamp
        model:
          type: string
          description: Model used
        choices:
          type: array
          items:
            type: object
            properties:
              index:
                type: integer
              message:
                type: object
                properties:
                  role:
                    type: string
                  content:
                    type: string
              finish_reason:
                type: string
        usage:
          type: object
          properties:
            prompt_tokens:
              type: integer
            completion_tokens:
              type: integer
            total_tokens:
              type: integer
      required:
        - id
        - object
        - created
        - model
        - choices
        - usage

    OpenAIModelsResponse:
      type: object
      properties:
        object:
          type: string
          default: "list"
        data:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              object:
                type: string
                default: "model"
              created:
                type: integer
              owned_by:
                type: string
                default: "jarvis"
      required:
        - object
        - data

tags:
  - name: Health
    description: Health and status endpoints
  - name: Models
    description: AI model backend management
  - name: Personas
    description: Persona listing
  - name: Chat
    description: Chat completion endpoints
  - name: Monitoring
    description: System monitoring and metrics
  - name: Management
    description: System configuration and persona management
  - name: OpenAI Compatible
    description: OpenAI API-compatible endpoints for drop-in replacement
